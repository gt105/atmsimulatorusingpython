import json
from typing import Dict


ATM_FILE = "atm_data.json"


class ATM:
    def __init__(self, data_file: str = ATM_FILE) -> None:
        self.data_file = data_file
        self.data: Dict[str, str | float] = self._load_data()

        # Default values if file is empty
        self.balance: float = float(self.data.get("balance", 10000.0))
        self.pin: str = str(self.data.get("pin", "1234"))

    def _load_data(self) -> Dict:
        """Load ATM data from JSON file."""
        try:
            with open(self.data_file, "r") as f:
                return json.load(f)
        except (FileNotFoundError, json.JSONDecodeError):
            return {}

    def _save_data(self) -> None:
        """Save ATM data to JSON file."""
        self.data["balance"] = self.balance
        self.data["pin"] = self.pin
        with open(self.data_file, "w") as f:
            json.dump(self.data, f, indent=4)

    def _verify_pin(self) -> bool:
        """Private method to verify user PIN."""
        entered_pin = input("Enter your PIN: ").strip()
        if entered_pin == self.pin:
            return True
        print("Incorrect PIN!")
        return False

    def check_balance(self) -> None:
        print(f"Your current balance is: {self.balance:.2f} INR")

    def deposit(self) -> None:
        try:
            amount = float(input("Enter amount to deposit: ").strip())
            if amount > 0:
                self.balance += amount
                self._save_data()
                print(f"Deposited {amount:.2f} INR successfully.")
            else:
                print("Amount must be greater than zero!")
        except ValueError:
            print("Invalid input! Please enter a numeric value.")

    def withdraw(self) -> None:
        try:
            amount = float(input("Enter amount to withdraw: ").strip())
            if amount <= 0:
                print("Amount must be greater than zero!")
            elif amount > self.balance:
                print("Insufficient balance!")
            else:
                self.balance -= amount
                self._save_data()
                print(f"Withdrawn {amount:.2f} INR successfully.")
        except ValueError:
            print("Invalid input! Please enter a numeric value.")

    def change_pin(self) -> None:
        old_pin = input("Enter current PIN: ").strip()
        if old_pin != self.pin:
            print("Incorrect current PIN!")
            return

        new_pin = input("Enter new PIN: ").strip()
        confirm_pin = input("Confirm new PIN: ").strip()
        if new_pin == confirm_pin:
            self.pin = new_pin
            self._save_data()
            print("PIN changed successfully!")
        else:
            print("PIN confirmation does not match!")


def main() -> None:
    atm = ATM()

    menu_options = {
        "1": lambda: atm.check_balance() if atm._verify_pin() else None,
        "2": lambda: atm.deposit() if atm._verify_pin() else None,
        "3": lambda: atm.withdraw() if atm._verify_pin() else None,
        "4": atm.change_pin,
        "5": lambda: print("Thank you for using the ATM. Goodbye!")
    }

    while True:
        print("\n=== ATM Menu ===")
        print("1. Check Balance")
        print("2. Deposit Money")
        print("3. Withdraw Money")
        print("4. Change PIN")
        print("5. Exit")

        choice = input("Enter your choice: ").strip()
        action = menu_options.get(choice)
        if action:
            action()
            if choice == "5":
                break
        else:
            print("Invalid choice! Please try again.")


if __name__ == "__main__":
    main()
